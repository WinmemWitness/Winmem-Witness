version: "3.9"

name: winmem

x-common-env: &common-env
  NODE_ENV: production
  WINMEM_LOG_LEVEL: ${WINMEM_LOG_LEVEL:-info}
  WINMEM_RPC_URL: ${WINMEM_RPC_URL:-https://api.mainnet-beta.solana.com}
  WINMEM_RPC_TIMEOUT_MS: ${WINMEM_RPC_TIMEOUT_MS:-20000}
  WINMEM_RPC_RETRIES: ${WINMEM_RPC_RETRIES:-5}
  WINMEM_RPC_CONCURRENCY: ${WINMEM_RPC_CONCURRENCY:-8}
  WINMEM_HASH_ALG: ${WINMEM_HASH_ALG:-SHA256}
  WINMEM_TENANCY_MODE: ${WINMEM_TENANCY_MODE:-single}
  WINMEM_PUBLIC_MODE: ${WINMEM_PUBLIC_MODE:-false}
  WINMEM_REDACTION_ENABLED: ${WINMEM_REDACTION_ENABLED:-true}
  WINMEM_OTEL_ENABLED: ${WINMEM_OTEL_ENABLED:-true}
  OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://tempo:4318}
  OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-winmem}
  OTEL_TRACES_SAMPLER: ${OTEL_TRACES_SAMPLER:-parentbased_traceidratio}
  OTEL_TRACES_SAMPLER_ARG: ${OTEL_TRACES_SAMPLER_ARG:-0.1}

x-db-env: &db-env
  DATABASE_URL: ${DATABASE_URL:-postgresql://winmem:winmem@postgres:5432/winmem}
  REDIS_URL: ${REDIS_URL:-redis://redis:6379}

x-api-keys: &api-keys
  WINMEM_API_KEY_ADMIN: ${WINMEM_API_KEY_ADMIN:-dev_admin_key_change_me}
  WINMEM_API_KEY_READONLY: ${WINMEM_API_KEY_READONLY:-dev_readonly_key_change_me}

services:
  postgres:
    image: postgres:16
    container_name: winmem-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-winmem}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-winmem}
      POSTGRES_DB: ${POSTGRES_DB:-winmem}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
      - ./postgres/tuning.conf:/etc/postgresql/postgresql.conf:ro
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-winmem} -d ${POSTGRES_DB:-winmem}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7
    container_name: winmem-redis
    restart: unless-stopped
    volumes:
      - redisdata:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: winmem-clickhouse
    restart: unless-stopped
    profiles: ["clickhouse"]
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-winmem}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-winmem}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-winmem}
    volumes:
      - chdata:/var/lib/clickhouse
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_NATIVE_PORT:-9000}:9000"
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8123/ping | grep -q Ok"]
      interval: 10s
      timeout: 5s
      retries: 10

  loki:
    image: grafana/loki:2.9.8
    container_name: winmem-loki
    restart: unless-stopped
    command: ["-config.file=/etc/loki/config.yml"]
    volumes:
      - ./loki/config.yml:/etc/loki/config.yml:ro
      - lokidata:/loki
    ports:
      - "${LOKI_PORT:-3100}:3100"

  tempo:
    image: grafana/tempo:2.6.1
    container_name: winmem-tempo
    restart: unless-stopped
    command: ["-config.file=/etc/tempo/config.yml"]
    volumes:
      - ./tempo/config.yml:/etc/tempo/config.yml:ro
      - tempodata:/var/tempo
    ports:
      - "${TEMPO_HTTP_PORT:-3200}:3200"
      - "${OTEL_HTTP_PORT:-4318}:4318"

  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: winmem-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - promdata:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"

  grafana:
    image: grafana/grafana:11.2.2
    container_name: winmem-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafanadata:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    depends_on:
      - prometheus
      - loki
      - tempo

  api:
    image: ${WINMEM_API_IMAGE:-ghcr.io/your-org/winmem-api:latest}
    container_name: winmem-api
    restart: unless-stopped
    environment:
      <<: [*common-env, *db-env, *api-keys]
      PORT: ${API_PORT:-8787}
      WINMEM_CORS_ORIGINS: ${WINMEM_CORS_ORIGINS:-http://localhost:3000}
      WINMEM_RATE_LIMIT_RPM: ${WINMEM_RATE_LIMIT_RPM:-600}
      WINMEM_PUBLIC_READONLY_KEY: ${WINMEM_PUBLIC_READONLY_KEY:-}
    ports:
      - "${API_PORT:-8787}:8787"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker:
    image: ${WINMEM_WORKER_IMAGE:-ghcr.io/your-org/winmem-worker:latest}
    container_name: winmem-worker
    restart: unless-stopped
    environment:
      <<: [*common-env, *db-env, *api-keys]
      WINMEM_WORKER_CONCURRENCY: ${WINMEM_WORKER_CONCURRENCY:-8}
      WINMEM_QUEUE_PREFIX: ${WINMEM_QUEUE_PREFIX:-winmem}
      WINMEM_PROOF_WINDOW_SECONDS: ${WINMEM_PROOF_WINDOW_SECONDS:-86400}
      WINMEM_WITNESS_CADENCE_SECONDS: ${WINMEM_WITNESS_CADENCE_SECONDS:-86400}
      WINMEM_ENABLE_LLM: ${WINMEM_ENABLE_LLM:-false}
      WINMEM_LLM_PROVIDER: ${WINMEM_LLM_PROVIDER:-openai}
      WINMEM_LLM_MODEL: ${WINMEM_LLM_MODEL:-gpt-4o-mini}
      WINMEM_LLM_API_KEY: ${WINMEM_LLM_API_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  web:
    image: ${WINMEM_WEB_IMAGE:-ghcr.io/your-org/winmem-web:latest}
    container_name: winmem-web
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_WINMEM_API_URL: ${NEXT_PUBLIC_WINMEM_API_URL:-http://localhost:8787}
      NEXT_PUBLIC_WINMEM_PUBLIC_MODE: ${WINMEM_PUBLIC_MODE:-false}
      NEXT_PUBLIC_WINMEM_BRAND: ${NEXT_PUBLIC_WINMEM_BRAND:-Winmem}
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - api

volumes:
  pgdata:
  redisdata:
  chdata:
  promdata:
  grafanadata:
  lokidata:
  tempodata:
